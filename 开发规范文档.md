# 模块化量化交易系统开发规范文档

## 1. TDD实践

### 1.1 开发流程
1. 编写失败的测试用例
2. 实现最少代码使测试通过
3. 重构代码
4. 重复步骤

### 1.2 开发日志规范

每步开发任务必须编写详细日志并git提交：

| 步骤 | 日志内容 | Git提交 |
|------|----------|---------|
| 需求分析 | 功能描述、输入输出、边界条件 | `feat: 分析[模块名]需求` |
| 设计决策 | 类结构、接口定义、依赖关系 | `feat: 设计[模块名]架构` |
| 代码实现 | 核心逻辑、关键算法、特殊处理 | `feat: 实现[模块名]核心功能` |
| 测试编写 | 测试用例、预期结果、边界覆盖 | `test: 添加[模块名]单元测试` |
| 代码重构 | 优化点、性能提升、可读性改进 | `refactor: 重构[模块名]代码` |
| Bug修复 | 问题描述、修复方案、影响范围 | `fix: 修复[问题描述]` |
| 文档更新 | 更新内容、影响模块、使用说明 | `docs: 更新[文档名]` |

**日志编写要求**：
- **开发日志文件**：每个模块根目录创建`DEVELOPMENT_LOG.md`
- **日志格式**：
  ```markdown
  # [模块名] 开发日志

  ## [日期] [作者]
  ### 任务名称
  ### 详细描述
  - 输入参数：
  - 输出结果：
  - 边界条件：
  - 注意事项：
  ### 遇到的 问题
  - 问题1：...
  - 解决方案：...
  ### 下一步计划
  ```
- **提交前检查**：
  - [ ] 日志已更新
  - [ ] 代码已格式化
  - [ ] 单元测试通过
  - [ ] 无 lint 警告
  - [ ] 与用户确认

### 1.3 测试要求
- 框架：pytest + unittest.mock
- 覆盖率：核心模块≥80%，关键功能≥90%

## 2. Git工作流

### 2.1 分支规范
| 分支 | 用途 | 合并目标 |
|------|------|----------|
| main | 生产代码 | - |
| develop | 开发代码 | main |
| feature/xxx | 新功能 | develop |
| bugfix/xxx | 修复bug | main/develop |
| release/vx.x.x | 版本发布 | main+develop |
| hotfix/xxx | 紧急修复 | main+develop |

### 2.2 提交规范
```
<type>: <subject>
[type]: feat/fix/docs/style/refactor/test/chore
- 简洁明了，不超过50字符
- 动词开头，首字母小写
[footer]: Closes #123 / Fixes #456
```

### 2.3 用户确认机制（替代传统代码评审）

每一步开发完成后、git提交前必须与用户确认：

| 确认阶段 | 确认内容 | 确认方式 | 通过标准 |
|----------|----------|----------|----------|
| 需求确认 | 功能理解、边界条件、输入输出 | 书面说明+用户回复 | 用户明确回复"确认" |
| 设计确认 | 类结构、接口定义、依赖关系 | 架构图+说明文档 | 用户确认架构可行 |
| 代码确认 | 核心逻辑、关键实现、代码风格 | 代码diff+说明 | 用户确认代码正确 |
| 测试确认 | 测试用例、覆盖范围、预期结果 | 测试代码+运行结果 | 用户确认测试通过 |
| 重构确认 | 优化内容、性能提升、可读性 | 前后对比+性能数据 | 用户确认改进有效 |

**确认流程**：
1. **准备阶段**：
   - 整理代码变更（git diff）
   - 编写变更说明（变更内容、影响范围、注意事项）
   - 运行测试确保通过
   - 代码格式化检查

2. **提交确认**：
   ```
   提交前确认：
   ┌─────────────────────────────────────┐
   │ 变更内容：                          │
   │ - 新增功能：xxx                     │
   │ - 修改内容：xxx                     │
   │ - 影响范围：xxx                     │
   ├─────────────────────────────────────┤
   │ 检查项：                            │
   │ [✓] 单元测试全部通过                │
   │ [✓] 代码无 lint 警告                │
   │ [✓] 代码已格式化                    │
   │ [✓] 文档已更新                      │
   │ [✓] 日志已记录                      │
   └─────────────────────────────────────┘
   
   请确认以上变更，回复"确认"后我将执行git提交。
   ```

3. **确认标准**：
   - 用户回复"确认"或"通过"视为通过
   - 用户提出问题需解答后重新确认
   - 紧急情况可先提交后补充确认（需记录）
   - 24小时内未回复可执行提交（需提醒）

**确认记录**：
- 在开发日志中记录确认时间、确认人、确认内容
- Git提交信息包含确认标记：`feat: xxx (confirmed)`
- 未确认的提交需在PR中说明原因

### 2.4 版本控制
- 格式：X.Y.Z（语义化版本）
- 标签：vX.Y.Z

## 3. 代码规范

### 3.1 代码风格
| 语言 | 规范 |
|------|------|
| Python | PEP 8，4空格，类名驼峰，函数/变量小写下划线 |
| JS/TS | ESLint，2空格，驼峰命名 |
| HTML/CSS | W3C规范，2空格，小写连字符 |

### 3.2 命名约定
| 类型 | 规则 | 示例 |
|------|------|------|
| 模块 | 小写下划线 | data_source.py |
| 类 | 驼峰 | StrategyEngine |
| 函数(Python) | 小写下划线 | get_historical_data |
| 函数(JS) | 驼峰 | getRealtimeData |
| 常量 | 全大写下划线 | MAX_RETRY_COUNT |
| 布尔 | is_/has_前缀 | is_connected |

### 3.3 代码结构
- 单一职责原则
- 函数≤50行，参数≤5个
- 低耦合高内聚
- 依赖注入，接口抽象

## 4. 文档注释

### 4.1 模块文档（Google风格）
```python
"""模块功能描述

依赖：
    - pandas
    - requests

使用示例：
    from module import Class

作者：张三
版本：1.0.0
"""
```

### 4.2 函数文档
```python
def func(param: type, param2: type = "default") -> return_type:
    """函数功能描述
    
    Args:
        param: 参数说明
        param2: 参数说明
        
    Returns:
        返回值说明
        
    Raises:
        ExceptionType: 异常说明
    """
```

### 4.3 注释原则
- 说明"为什么做"，而非"做了什么"
- 复杂逻辑、特殊处理前添加注释

## 5. 错误处理

### 5.1 异常处理
- 定义自定义异常类
- 捕获具体异常，避免bare except
- 可恢复异常实现重试
- 记录详细日志

### 5.2 日志规范
| 级别 | 用途 |
|------|------|
| DEBUG | 调试信息 |
| INFO | 运行状态 |
| WARNING | 潜在问题 |
| ERROR | 可恢复错误 |
| CRITICAL | 不可恢复错误 |

**格式**：时间戳 - 级别 - 模块 - 函数 - 消息

## 6. 测试规范

### 6.1 测试类型
单元测试 → 集成测试 → 接口测试 → 性能测试 → 压力测试 → 回归测试

### 6.2 测试覆盖率
- 核心模块：≥90%
- 其他模块：≥80%
- 分支覆盖率：≥80%
- 关键路径：≥90%

## 7. 安全编码
- **输入验证**：格式、类型、长度、范围
- **敏感数据**：环境变量存储、加密传输、HTTPS
- **权限控制**：RBAC、最小权限、服务器端验证
- **安全审计**：关键操作日志、定期审计

## 8. CI/CD

### 8.1 自动化流程
| 阶段 | 触发条件 | 内容 |
|------|----------|------|
| 构建 | PR/代码提交 | 安装依赖、静态分析、单元测试、构建镜像 |
| 测试 | 同上 | 单元/集成/接口/性能测试 |
| 部署 | 代码合并 | 开发环境(自动)、测试环境(自动)、生产环境(手动) |

### 8.2 监控告警
- **监控**：CPU/内存/磁盘、API响应时间、数据库指标
- **告警**：邮件/短信/微信、分级策略

## 9. AI开发约束规范

### 9.1 信息获取约束

AI在开发过程中应主动询问用户获取关键信息，避免假设和猜测：

| 场景 | 询问内容 |
|------|----------|
| 需求不明确 | 功能细节、业务规则、用户流程 |
| 技术选型不确定 | 偏好框架、性能要求、维护能力 |
| 设计决策影响大 | 架构选择、扩展方案、兼容要求 |
| 第三方依赖 | 现有库使用、许可证要求、安全评估 |
| 边界情况 | 异常处理、输入限制、数据规模 |

**询问原则**：
- 优先级递减：核心功能→性能要求→用户体验→代码风格
- 提供选项：给出2-3个方案供选择，降低用户决策成本
- 解释利弊：说明各方案的优缺点，帮助用户做出明智决策
- 确认理解：复述用户需求，确保理解正确

### 9.2 决策确认机制

以下场景需获得用户明确确认后再执行：

| 决策类型 | 确认内容 | 确认方式 |
|----------|----------|----------|
| 架构变更 | 模块拆分、服务划分、数据流向 | 书面确认或会议讨论 |
| 依赖变更 | 新增库、版本升级、替代方案 | PR中的详细说明 |
| 破坏性变更 | API修改、数据库迁移、接口废弃 | 独立评审+用户审批 |
| 安全相关 | 认证方式、加密策略、权限模型 | 安全团队评审 |
| 性能影响 | 异步改同步、缓存策略、索引设计 | 性能测试报告 |

**确认流程**：
1. 提供变更方案和影响分析
2. 列出备选方案及对比
3. 等待用户明确回复
4. 记录确认结果（时间、内容、确认人）
5. 执行变更并跟踪效果

### 9.3 代码生成约束

AI生成的代码必须遵循以下约束：

| 约束类型 | 具体要求 |
|----------|----------|
| 遵循规范 | 使用项目定义的代码风格、命名约定、模块结构 |
| 避免硬编码 | 配置信息使用环境变量或配置文件 |
| 错误处理 | 所有外部调用必须try-catch，记录详细错误信息 |
| 类型安全 | Python使用类型注解，JS使用TypeScript或JSDoc |
| 资源管理 | 数据库连接、网络请求等需正确释放 |
| 并发安全 | 多线程/异步操作使用适当的同步机制 |
| 测试覆盖 | 核心逻辑需附带单元测试，复杂函数需边界测试 |

**生成检查清单**：
- [ ] 代码符合项目规范
- [ ] 无敏感信息硬编码
- [ ] 必要的错误处理和日志
- [ ] 类型注解完整
- [ ] 单元测试覆盖核心逻辑
- [ ] 文档注释齐全

### 9.4 安全约束

AI生成的代码必须符合安全编码标准：

| 约束 | 说明 |
|------|------|
| 无 secrets | 禁止生成包含API密钥、密码、token的代码 |
| 输入验证 | 所有外部输入必须验证类型、格式、范围 |
| SQL注入防护 | 使用参数化查询，禁止字符串拼接 |
| XSS防护 | 输出编码，React使用JSX转义 |
| 权限检查 | 敏感操作前验证用户权限 |
| 敏感数据 | 禁止日志记录密码、token等敏感信息 |
| 加密传输 | HTTPS外部通信，敏感数据加密存储 |

**安全审查清单**：
- [ ] 无硬编码 secrets
- [ ] 输入验证完整
- [ ] 无SQL注入风险
- [ ] 无XSS风险
- [ ] 权限检查到位
- [ ] 敏感数据保护

### 9.5 文档与沟通约束

| 约束类型 | 具体要求 |
|----------|----------|
| 设计说明 | 复杂算法、架构决策需说明设计思路和权衡 |
| 代码注释 | 关键逻辑添加行内注释，说明"为什么"而非"做什么" |
| TODO标记 | 未完成功能标记TODO，注明原因和预计完成时间 |
| 变更说明 | 每次代码变更说明变更内容、影响范围、注意事项 |
| 进度同步 | 长时间任务定期汇报进展，阻塞时主动说明 |

**沟通原则**：
- 复杂问题分步骤说明，避免一次性大量信息
- 重要决策提供书面说明，便于团队review
- 发现新问题及时报告，不隐瞒风险
- 完成阶段任务主动汇报，获取反馈

### 9.6 执行边界约束

| 边界类型 | 约束内容 |
|----------|----------|
| 代码权限 | 仅修改指定文件，不自动修改未授权文件 |
| 依赖管理 | 新增依赖需说明版本选择理由，经确认后添加 |
| 配置文件 | 仅修改与任务相关的配置项 |
| 测试数据 | 使用mock数据，不修改生产数据库 |
| 自动化操作 | 构建、部署等操作需用户明确触发 |
| 外部调用 | 第三方API调用需配置超时和重试 |

**例外处理**：
- 安全补丁可立即执行，事后报告
- 明显的拼写错误、格式问题可自动修复
- 紧急故障修复可先执行后补充说明

